# {{ ansible_managed }}

<VirtualHost {{apache_host|default('*')}}:{{apache_port}}>
    ServerAdmin                           {{ item['admin_email'] }}
    ServerName                            {{ item['host'] }}
{% for alias in item['aliases']|default([]) %}
    ServerAlias                           {{ alias }}
{% endfor %}

    DocumentRoot                 {{ vhost_base_path }}/{{ item['host'] }}/public_html/
    ErrorLog                     {{ vhost_base_path }}/{{ item['host'] }}/logs/error.log

{% if apache2_mpm == 'prefork' %}
    php_admin_value error_log    {{ vhost_base_path }}/{{ item['host'] }}/logs/php.error.log
{% endif %}

{% if apache2_mpm != 'prefork' %}
    # Force Apache to pass the Authorization
    # header to PHP: required for "basic_auth" under PHP-FPM and FastCGI
    SetEnvIfNoCase ^Authorization$ "(.+)" HTTP_AUTHORIZATION=$1
    
    # Using TCP sockets (Unix sockets need Apache 2.4.10).
    ProxyPassMatch ^/(.*\.php(/.*)?)$ fcgi://{{ fpm_host }}:{{  fpm_port }}{{ vhost_base_path }}/{{ item['host'] }}/public_html/$1
{% endif %}

    <Directory {{ vhost_base_path }}/{{ item['host'] }}/public_html/>
        Options +Indexes +FollowSymLinks
        DirectoryIndex index.html index.php
    <IfModule mod_access_compat.c>
        Order allow,deny
        Allow from all
    </IfModule>
    <IfModule !mod_access_compat.c>
        Require all granted
    </IfModule>
        AllowOverride All
    </Directory>

    <IfModule mod_expires.c>
        ExpiresActive On
        ExpiresByType image/gif "access plus 1 months"
        ExpiresByType image/jpg "access plus 1 months"
        ExpiresByType image/jpeg "access plus 1 months"
        ExpiresByType image/png "access plus 1 months"
        ExpiresByType image/vnd.microsoft.icon "access plus 1 months"
        ExpiresByType image/x-icon "access plus 1 months"
        ExpiresByType image/ico "access plus 1 months"
        ExpiresByType application/javascript "now plus 1 months"
        ExpiresByType application/x-javascript "now plus 1 months"
        ExpiresByType text/javascript "now plus 1 months"
        ExpiresByType text/css "now plus 1 months"
        ExpiresDefault "access plus 1 days"
    </IfModule>

</VirtualHost>
